/**
 * GigaChat API Integration
 * 
 * –î–ª—è —Ä–∞–±–æ—Ç—ã —Å API GigaChat –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:
 * 1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ https://developers.sber.ru/gigachat
 * 2. –ü–æ–ª—É—á–∏—Ç—å –ª–∏–±–æ Authorization Key, –ª–∏–±–æ Client ID + Client Secret
 * 3. –î–æ–±–∞–≤–∏—Ç—å –∏—Ö –≤ .env —Ñ–∞–π–ª:
 *    –í–ê–†–ò–ê–ù–¢ 1 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è): VITE_GIGACHAT_AUTH_KEY=your_authorization_key
 *    –í–ê–†–ò–ê–ù–¢ 2: VITE_GIGACHAT_CLIENT_ID=your_client_id
 *               VITE_GIGACHAT_CLIENT_SECRET=your_client_secret
 * 
 * –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ
 */

// –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –≤ development)
if (import.meta.env.DEV) {
  const authKey = import.meta.env.VITE_GIGACHAT_AUTH_KEY;
  const clientId = import.meta.env.VITE_GIGACHAT_CLIENT_ID;
  const clientSecret = import.meta.env.VITE_GIGACHAT_CLIENT_SECRET;
  
  console.group('üîç GigaChat API Configuration Diagnostic');
  console.log('Environment:', import.meta.env.MODE);
  console.log('VITE_GIGACHAT_AUTH_KEY:', authKey ? `‚úì –ù–∞–π–¥–µ–Ω (${authKey.substring(0, 10)}...)` : '‚úó –ù–µ –Ω–∞–π–¥–µ–Ω');
  console.log('VITE_GIGACHAT_CLIENT_ID:', clientId ? `‚úì –ù–∞–π–¥–µ–Ω (${clientId.substring(0, 10)}...)` : '‚úó –ù–µ –Ω–∞–π–¥–µ–Ω');
  console.log('VITE_GIGACHAT_CLIENT_SECRET:', clientSecret ? '‚úì –ù–∞–π–¥–µ–Ω' : '‚úó –ù–µ –Ω–∞–π–¥–µ–Ω');
  
  if (!authKey && (!clientId || !clientSecret)) {
    console.error('‚ùå –ù–ï–¢ –ö–õ–Æ–ß–ï–ô! –î–æ–±–∞–≤—å—Ç–µ –≤ .env —Ñ–∞–π–ª:');
    console.error('   VITE_GIGACHAT_AUTH_KEY=your_key');
    console.error('   –ò–õ–ò');
    console.error('   VITE_GIGACHAT_CLIENT_ID=your_id');
    console.error('   VITE_GIGACHAT_CLIENT_SECRET=your_secret');
  } else {
    console.log('‚úÖ –ö–ª—é—á–∏ –Ω–∞–π–¥–µ–Ω—ã, API –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å');
  }
  console.groupEnd();
}

import { apiFetch } from "./api";

interface GigaChatMessage {
  role: 'system' | 'user' | 'assistant';
  content: string;
}

interface GigaChatRequest {
  model: string;
  messages: GigaChatMessage[];
  temperature?: number;
  max_tokens?: number;
}

interface GigaChatResponse {
  choices: Array<{
    message: {
      content: string;
    };
  }>;
}

interface TokenResponse {
  access_token: string;
  expires_at: string;
}

// –ö—ç—à –¥–ª—è —Ç–æ–∫–µ–Ω–∞
let cachedToken: TokenResponse | null = null;
const backendBaseUrl = import.meta.env.VITE_BACKEND_URL;
const useBackendProxy = Boolean(backendBaseUrl);

// –¢–∞–π–º–∞—É—Ç—ã (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
const OAUTH_TIMEOUT = 10000; // 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è OAuth
const API_TIMEOUT = 60000; // 60 —Å–µ–∫—É–Ω–¥ –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤

// URL —á–µ—Ä–µ–∑ Vite proxy (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ Vite dev —Å–µ—Ä–≤–µ—Ä–∞, –Ω–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å!)
// –í development: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è proxy –∏–∑ vite.config.ts
// –í production: –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ –∂–µ URL –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å backend proxy
const isDevelopment = import.meta.env.DEV;
const GIGACHAT_OAUTH_URL = isDevelopment
  ? '/api/gigachat-oauth/api/v2/oauth'  // –ß–µ—Ä–µ–∑ Vite proxy (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π, –Ω–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä!)
  : 'https://ngw.devices.sberbank.ru:9443/api/v2/oauth';

const GIGACHAT_API_URL = isDevelopment
  ? '/api/gigachat-api/api/v1/chat/completions'  // –ß–µ—Ä–µ–∑ Vite proxy
  : 'https://gigachat.devices.sberbank.ru/api/v1/chat/completions';

/**
 * –°–æ–∑–¥–∞—ë—Ç fetch —Å —Ç–∞–π–º–∞—É—Ç–æ–º
 */
async function fetchWithTimeout(url: string, options: RequestInit, timeout: number): Promise<Response> {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), timeout);

  try {
    const response = await fetch(url, {
      ...options,
      signal: controller.signal,
    });
    clearTimeout(timeoutId);
    return response;
  } catch (error) {
    clearTimeout(timeoutId);
    if (error instanceof Error && error.name === 'AbortError') {
      throw new GigaChatError(
        'TIMEOUT',
        `–ó–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (${timeout / 1000} —Å–µ–∫—É–Ω–¥)`
      );
    }
    throw error;
  }
}

/**
 * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è GigaChat API
 */
class GigaChatError extends Error {
  code: string;
  details?: unknown;

  constructor(code: string, message: string, details?: unknown) {
    super(message);
    this.name = 'GigaChatError';
    this.code = code;
    this.details = details;
  }
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ GigaChat API —á–µ—Ä–µ–∑ OAuth
 * 
 * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ –º–µ—Ç–æ–¥–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
 * 1. Authorization Key (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) - –ø—Ä–æ—â–µ –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
 * 2. Client ID + Client Secret - –∫–æ–¥–∏—Ä—É—é—Ç—Å—è –≤ Base64
 * 
 * –î–∞–Ω–Ω—ã–µ –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –Ω—É–∂–Ω—ã –æ—Ç GigaChat:
 * - Authorization Key (–∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞, –∫–Ω–æ–ø–∫–∞ "–ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á")
 *   –ò–õ–ò
 * - Client ID –∏ Client Secret (–∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API")
 */
async function getAccessToken(): Promise<string> {
  if (useBackendProxy) {
    throw new GigaChatError(
      "BACKEND_PROXY",
      "–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ backend proxy",
    );
  }
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Authorization Key (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –º–µ—Ç–æ–¥)
  const authKey = import.meta.env.VITE_GIGACHAT_AUTH_KEY;
  const clientId = import.meta.env.VITE_GIGACHAT_CLIENT_ID;
  const clientSecret = import.meta.env.VITE_GIGACHAT_CLIENT_SECRET;

  // –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
  console.group('üîê getAccessToken: Checking credentials');
  console.log('Auth Key:', authKey ? `Found (${authKey.substring(0, 20)}...)` : 'Not found');
  console.log('Client ID:', clientId ? `Found (${clientId.substring(0, 20)}...)` : 'Not found');
  console.log('Client Secret:', clientSecret ? 'Found' : 'Not found');
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  let authorizationHeader: string;
  
  if (authKey) {
    // –ú–µ—Ç–æ–¥ 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º Authorization Key –Ω–∞–ø—Ä—è–º—É—é
    console.log('‚úÖ Using Authorization Key method');
    authorizationHeader = `Basic ${authKey}`;
  } else if (clientId && clientSecret) {
    // –ú–µ—Ç–æ–¥ 2: –ö–æ–¥–∏—Ä—É–µ–º Client ID –∏ Secret –≤ Base64
    console.log('‚úÖ Using Client ID + Secret method');
    const credentials = btoa(`${clientId}:${clientSecret}`);
    authorizationHeader = `Basic ${credentials}`;
  } else {
    console.error('‚ùå NO CREDENTIALS FOUND!');
    console.error('Available env vars:', Object.keys(import.meta.env).filter(k => k.includes('GIGACHAT')));
    console.groupEnd();
    throw new GigaChatError(
      'NO_CREDENTIALS',
      '–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ GigaChat –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ VITE_GIGACHAT_AUTH_KEY (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) –∏–ª–∏ VITE_GIGACHAT_CLIENT_ID –∏ VITE_GIGACHAT_CLIENT_SECRET –≤ —Ñ–∞–π–ª .env –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ dev —Å–µ—Ä–≤–µ—Ä'
    );
  }
  console.groupEnd();

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à —Ç–æ–∫–µ–Ω–∞
  if (cachedToken && cachedToken.expires_at) {
    const expiresAt = new Date(cachedToken.expires_at).getTime();
    const now = Date.now();
    // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—â–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω (—Å –∑–∞–ø–∞—Å–æ–º –≤ 1 –º–∏–Ω—É—Ç—É), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    if (expiresAt > now + 60000) {
      return cachedToken.access_token;
    }
  }

  try {
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π RqUID
    const rqUID = crypto.randomUUID();

    console.log('Requesting OAuth token from:', GIGACHAT_OAUTH_URL);

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º mode: 'cors' –∏ credentials: 'omit' –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å CORS
    const response = await fetchWithTimeout(
      GIGACHAT_OAUTH_URL,
      {
        method: 'POST',
        mode: 'cors', // –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º CORS —Ä–µ–∂–∏–º
        credentials: 'omit', // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º cookies
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json',
          'RqUID': rqUID,
          'Authorization': authorizationHeader,
        },
        body: 'scope=GIGACHAT_API_PERS',
      },
      OAUTH_TIMEOUT
    );

    if (!response.ok) {
      const errorText = await response.text();
      console.error('GigaChat OAuth error:', {
        status: response.status,
        statusText: response.statusText,
        url: GIGACHAT_OAUTH_URL,
        error: errorText
      });
      
      let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞';
      if (response.status === 401) {
        errorMessage = authKey
          ? '–ù–µ–≤–µ—Ä–Ω—ã–π Authorization Key. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ VITE_GIGACHAT_AUTH_KEY –≤ .env —Ñ–∞–π–ª–µ'
          : '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Client ID –∏ Client Secret –≤ .env —Ñ–∞–π–ª–µ';
      } else if (response.status === 429) {
        errorMessage = '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';
      } else if (response.status >= 500) {
        errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ GigaChat. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';
      } else if (response.status === 500) {
        errorMessage = `–û—à–∏–±–∫–∞ –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ (500). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å Authorization Key –∏–ª–∏ Client ID/Secret\n2. –ù–∞–ª–∏—á–∏–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è\n3. –õ–æ–≥–∏ Vite dev —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π`;
      }
      
      throw new GigaChatError(`OAUTH_${response.status}`, errorMessage, { 
        status: response.status, 
        statusText: response.statusText,
        details: errorText 
      });
    }

    const data = await response.json();
    
    if (!data.access_token) {
      throw new GigaChatError('INVALID_RESPONSE', '–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', data);
    }
    
    // –ö—ç—à–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω (–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 30 –º–∏–Ω—É—Ç)
    const expiresAt = new Date(Date.now() + 30 * 60 * 1000);
    cachedToken = {
      access_token: data.access_token,
      expires_at: expiresAt.toISOString(),
    };
    
    console.log('OAuth token obtained successfully');
    return data.access_token;
  } catch (error) {
    if (error instanceof GigaChatError) {
      throw error;
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
    console.error('Network error during OAuth:', error);
    throw new GigaChatError(
      'NETWORK_ERROR',
      '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É',
      error instanceof Error ? error.message : String(error)
    );
  }
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∏—Å–ø–æ–ª—å–∑—É—è GigaChat API
 * 
 * –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ GigaChat API:
 * - model: –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "GigaChat")
 * - messages: –º–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ä–æ–ª—è–º–∏:
 *   - role: "system" | "user" | "assistant"
 *   - content: —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
 * - temperature: –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ (0.0-1.0, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0.7)
 * - max_tokens: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 2000)
 * 
 * –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:
 * –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º access_token —á–µ—Ä–µ–∑ OAuth
 * –ó–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ Authorization: Bearer {access_token}
 */
export async function generateTextWithGigaChat(
  prompt: string,
  systemPrompt?: string
): Promise<string> {
  const messages: GigaChatMessage[] = [];
  
  if (systemPrompt) {
    messages.push({ role: 'system', content: systemPrompt });
  }
  
  messages.push({ role: 'user', content: prompt });

  try {
    if (useBackendProxy) {
      const response = await apiFetch<any>("/api/gigachat/generate", {
        method: "POST",
        body: {
          prompt,
          systemPrompt,
          max_tokens: 2048,
          temperature: 0.7,
        },
      });

      const choice = response?.choices?.[0]?.message?.content;
      if (!choice) {
        throw new GigaChatError(
          "INVALID_RESPONSE",
          "Proxy –≤–µ—Ä–Ω—É–ª –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç",
          response,
        );
      }
      return choice;
    }

    // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞
    const accessToken = await getAccessToken();

    const response = await fetchWithTimeout(
      GIGACHAT_API_URL,
      {
        method: 'POST',
        mode: 'cors', // –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º CORS —Ä–µ–∂–∏–º
        credentials: 'omit', // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º cookies
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Authorization': `Bearer ${accessToken}`,
        },
        body: JSON.stringify({
          model: 'GigaChat',
          messages,
          temperature: 0.7,
          max_tokens: 2000,
        } as GigaChatRequest),
      },
      API_TIMEOUT
    );

    if (!response.ok) {
      const errorText = await response.text();
      console.error('GigaChat API error:', response.status, errorText);
      
      let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞';
      if (response.status === 401) {
        errorMessage = '–¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ —É—Å—Ç–∞—Ä–µ–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞';
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ 401
        cachedToken = null;
      } else if (response.status === 429) {
        errorMessage = '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ';
      } else if (response.status >= 500) {
        errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ GigaChat. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';
      } else if (response.status === 400) {
        errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
      }
      
      throw new GigaChatError(`API_${response.status}`, errorMessage, { status: response.status, details: errorText });
    }

    const data: GigaChatResponse = await response.json();
    
    if (!data.choices || data.choices.length === 0) {
      throw new GigaChatError('EMPTY_RESPONSE', '–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç GigaChat');
    }

    return data.choices[0].message.content;
  } catch (error) {
    if (error instanceof GigaChatError) {
      throw error;
    }
    
    if (error instanceof Error) {
      if (error.message.includes('fetch') || error.message.includes('network')) {
        throw new GigaChatError('NETWORK_ERROR', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É');
      }
      throw new GigaChatError('UNKNOWN_ERROR', `–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, error);
    }
    
    throw new GigaChatError('UNKNOWN_ERROR', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞');
  }
}

/**
 * –¢–∏–ø—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
 */
export const documentTypes = {
  essay: { 
    name: '–†–µ—Ñ–µ—Ä–∞—Ç', 
    minSections: 3, 
    maxSections: 7, 
    targetChars: 5000,
    description: '–ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä —Ç–µ–º—ã —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –≤—ã–≤–æ–¥–∞–º–∏'
  },
  courseWork: { 
    name: '–ö—É—Ä—Å–æ–≤–∞—è —Ä–∞–±–æ—Ç–∞', 
    minSections: 5, 
    maxSections: 10, 
    targetChars: 15000,
    description: '–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —á–∞—Å—Ç—å—é'
  },
  diploma: { 
    name: '–î–∏–ø–ª–æ–º–Ω–∞—è —Ä–∞–±–æ—Ç–∞', 
    minSections: 8, 
    maxSections: 15, 
    targetChars: 40000,
    description: '–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å –≥–ª—É–±–æ–∫–∏–º –∞–Ω–∞–ª–∏–∑–æ–º'
  },
  article: { 
    name: '–ù–∞—É—á–Ω–∞—è —Å—Ç–∞—Ç—å—è', 
    minSections: 3, 
    maxSections: 6, 
    targetChars: 12000,
    description: '–ö—Ä–∞—Ç–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏'
  },
  report: { 
    name: '–û—Ç—á—ë—Ç', 
    minSections: 4, 
    maxSections: 8, 
    targetChars: 10000,
    description: '–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ'
  },
} as const;

export type DocumentType = keyof typeof documentTypes;

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã –∏ —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
 */
export async function generateDocumentStructure(
  theme: string,
  docType: DocumentType,
  sourceMaterials?: string
): Promise<Array<{
  title: string;
  description: string;
  estimatedChars: number;
  subsections: string[];
}>> {
  const docTypeInfo = documentTypes[docType];
  
  let materialsPrompt = "";
  if (sourceMaterials && sourceMaterials.trim()) {
    materialsPrompt = `

–ò—Å—Ö–æ–¥–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –¥–∞–Ω–Ω—ã–µ:
${sourceMaterials}

–£—á—Ç–∏ —ç—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞.`;
  }
  
  const prompt = `–°–æ–∑–¥–∞–π –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É ${docTypeInfo.name.toLowerCase()} –Ω–∞ —Ç–µ–º—É: "${theme}"${materialsPrompt}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑–¥–µ–ª–æ–≤: ${docTypeInfo.minSections}-${docTypeInfo.maxSections}
- –¶–µ–ª–µ–≤–æ–π –æ–±—ä—ë–º: ${docTypeInfo.targetChars.toLocaleString('ru-RU')} —Å–∏–º–≤–æ–ª–æ–≤
- –°—Ç–∏–ª—å: –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π, –Ω–∞—É—á–Ω—ã–π
- –í–∫–ª—é—á–∏ —Ä–∞–∑–¥–µ–ª—ã, –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ —É–ø–æ–º—è–Ω—É—Ç—å —Ç–∞–±–ª–∏—Ü—ã –∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑", "–î–∏–Ω–∞–º–∏–∫–∞ —Ä–∞–∑–≤–∏—Ç–∏—è")

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ JSON –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –ø–æ–ª—è–º–∏:
- title: –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
- description: –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞ (–≤–∫–ª—é—á–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü/–≥—Ä–∞—Ñ–∏–∫–æ–≤ –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ)
- estimatedChars: –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π –æ–±—ä—ë–º —Ä–∞–∑–¥–µ–ª–∞ –≤ —Å–∏–º–≤–æ–ª–∞—Ö
- subsections: –º–∞—Å—Å–∏–≤ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–æ–≤ –∏–ª–∏ –∫–ª—é—á–µ–≤—ã—Ö –ø—É–Ω–∫—Ç–æ–≤

–§–æ—Ä–º–∞—Ç JSON:
[
  {
    "title": "–í–≤–µ–¥–µ–Ω–∏–µ",
    "description": "–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–º—ã, —Ü–µ–ª–∏ –∏ –∑–∞–¥–∞—á–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è...",
    "estimatedChars": 1000,
    "subsections": ["–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–º—ã", "–¶–µ–ª—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è", "–ó–∞–¥–∞—á–∏"]
  },
  {
    "title": "–û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å",
    "description": "–ê–Ω–∞–ª–∏–∑ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ —Ç–µ–º—ã. –ì–¥–µ —É–º–µ—Å—Ç–Ω–æ, —É–ø–æ–º—è–Ω–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —Ç–∞–±–ª–∏—Ü –∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏.",
    "estimatedChars": 3000,
    "subsections": [...]
  }
]

–í–ê–ñ–ù–û: 
- –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑–¥–µ–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "–°–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã" —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º "–°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ –ì–û–°–¢/APA".
- –ù–µ —Å–æ–∑–¥–∞–≤–∞–π –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è —Ä–∞–∑–¥–µ–ª–æ–≤ —Å–æ —Å–ø–∏—Å–∫–æ–º –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã.
- –ì–¥–µ —É–º–µ—Å—Ç–Ω–æ, –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ —Ä–∞–∑–¥–µ–ª–∞ —É–ø–æ–º—è–Ω–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤.

–ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–æ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —Ç–æ–ª—å–∫–æ JSON.`;

  const systemPrompt = `–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –°–æ–∑–¥–∞–≤–∞–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –∫ —Ç–∏–ø—É –¥–æ–∫—É–º–µ–Ω—Ç–∞.`;

  try {
    const response = await generateTextWithGigaChat(prompt, systemPrompt);
    
    // Extract JSON from response
    const jsonMatch = response.match(/\[[\s\S]*\]/);
    if (!jsonMatch) {
      throw new GigaChatError('PARSE_ERROR', '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞');
    }

    const structure = JSON.parse(jsonMatch[0]);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    if (!Array.isArray(structure) || structure.length === 0) {
      throw new GigaChatError('INVALID_STRUCTURE', '–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞');
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∏–±–ª–∏–æ–≥—Ä–∞—Ñ–∏–∏ –∏ —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
    const bibliographyKeywords = ['–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä', '–∏—Å—Ç–æ—á–Ω–∏–∫–∏', '–±–∏–±–ª–∏–æ–≥—Ä–∞—Ñ–∏—è', '—Å–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–π'];
    const bibliographyIndexes: number[] = [];
    
    structure.forEach((section, index) => {
      const titleLower = section.title.toLowerCase();
      if (bibliographyKeywords.some(keyword => titleLower.includes(keyword))) {
        bibliographyIndexes.push(index);
      }
    });
    
    // –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–¥–µ–ª–æ–≤ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π
    if (bibliographyIndexes.length > 1) {
      // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ (—É–¥–∞–ª—è–µ–º –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ, —á—Ç–æ–±—ã –∏–Ω–¥–µ–∫—Å—ã –Ω–µ —Å–¥–≤–∏–≥–∞–ª–∏—Å—å)
      bibliographyIndexes.slice(0, -1).reverse().forEach(index => {
        structure.splice(index, 1);
      });
    }
    
    // –ï—Å–ª–∏ –±–∏–±–ª–∏–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ—Ç –≤–æ–æ–±—â–µ, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü
    if (bibliographyIndexes.length === 0) {
      structure.push({
        title: '–°–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã',
        description: '–ü–µ—Ä–µ—á–µ–Ω—å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –≤ —Ä–∞–±–æ—Ç–µ, –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã—Ö –ø–æ –ì–û–°–¢ –∏–ª–∏ APA. –í–∫–ª—é—á–∏ –æ—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏ –∑–∞—Ä—É–±–µ–∂–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏.',
        estimatedChars: 1000,
        subsections: ['–û—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏', '–ó–∞—Ä—É–±–µ–∂–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏']
      });
    }
    
    return structure;
  } catch (error) {
    if (error instanceof GigaChatError) {
      throw error;
    }
    
    if (error instanceof SyntaxError) {
      throw new GigaChatError('JSON_PARSE_ERROR', '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç–≤–µ—Ç–∞');
    }
    
    throw error;
  }
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã –ø–æ –ì–û–°–¢
 */
export async function generateBibliography(theme: string): Promise<string> {
  const prompt = `–°–æ–∑–¥–∞–π —Å–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã –ø–æ –ì–û–°–¢ –† 7.0.5-2008 –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ —Ç–µ–º—É: "${theme}"

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –°–æ–∑–¥–∞–π 8-15 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–∫–Ω–∏–≥–∏, —Å—Ç–∞—Ç—å–∏, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Ä–µ—Å—É—Ä—Å—ã).
2. –ö–∞–∂–¥—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –Ω–æ–º–µ—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "1.", "2.", "3." –∏ —Ç.–¥. –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤.
3. –§–æ—Ä–º–∞—Ç –∑–∞–ø–∏—Å–∏ —Å—Ç—Ä–æ–≥–æ –ø–æ –ì–û–°–¢ –† 7.0.5-2008. –î–ª—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Ä–µ—Å—É—Ä—Å–æ–≤ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–π URL –∏ –¥–∞—Ç—É –æ–±—Ä–∞—â–µ–Ω–∏—è.
4. –í–∫–ª—é—á–∏ –æ—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–º–∏–Ω–∏–º—É–º 3-5) –∏ –∑–∞—Ä—É–±–µ–∂–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–º–∏–Ω–∏–º—É–º 3-5).
5. –ò—Å–ø–æ–ª—å–∑—É–π –†–ï–ê–õ–¨–ù–´–ï –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∞–≤—Ç–æ—Ä—ã, –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∞–π—Ç—ã).
6. –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑—å —Ç–∏–ø—ã –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: –º–æ–Ω–æ–≥—Ä–∞—Ñ–∏–∏, —Å—Ç–∞—Ç—å–∏, –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á—ë—Ç—ã, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Ä–µ—Å—É—Ä—Å—ã.

–§–û–†–ú–ê–¢ –ì–û–°–¢:
- –ö–Ω–∏–≥–∞: 1. –ê–≤—Ç–æ—Ä. –ù–∞–∑–≤–∞–Ω–∏–µ / –ê–≤—Ç–æ—Ä. ‚Äì –ú–µ—Å—Ç–æ –∏–∑–¥–∞–Ω–∏—è: –ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ, –≥–æ–¥. ‚Äì –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü —Å.
- –°—Ç–∞—Ç—å—è: 2. –ê–≤—Ç–æ—Ä. –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ // –ù–∞–∑–≤–∞–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞. ‚Äì –ì–æ–¥. ‚Äì ‚Ññ –Ω–æ–º–µ—Ä. ‚Äì –°. —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
- –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-—Ä–µ—Å—É—Ä—Å: 3. –ù–∞–∑–≤–∞–Ω–∏–µ [–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π —Ä–µ—Å—É—Ä—Å]. ‚Äì URL: —Å—Å—ã–ª–∫–∞ (–¥–∞—Ç–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è: –î–î.–ú–ú.–ì–ì–ì–ì).

–ü–†–ò–ú–ï–†–´ (—Å–æ—Ö—Ä–∞–Ω—è–π –Ω—É–º–µ—Ä–∞—Ü–∏—é "N."):
1. –ò–≤–∞–Ω–æ–≤ –ò.–ò. –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –≤ —ç–∫–æ–Ω–æ–º–∏–∫–µ / –ò.–ò. –ò–≤–∞–Ω–æ–≤. ‚Äì –ú.: –ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ, 2023. ‚Äì 234 —Å.
2. –ü–µ—Ç—Ä–æ–≤ –ü.–ü. –¶–∏—Ñ—Ä–æ–≤–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å–∞ // –≠–∫–æ–Ω–æ–º–∏–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ. ‚Äì 2023. ‚Äì ‚Ññ 5. ‚Äì –°. 45‚Äì67.
3. McKinsey Global Institute. The future of work in the age of AI [–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π —Ä–µ—Å—É—Ä—Å]. ‚Äì URL: https://www.mckinsey.com (–¥–∞—Ç–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è: 15.01.2024).

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, –∫–∞–∂–¥—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ.
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –ø–æ—è—Å–Ω–µ–Ω–∏—è, –≤–≤–æ–¥–Ω—ã–µ –∞–±–∑–∞—Ü—ã, –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown-—Ä–∞–∑–º–µ—Ç–∫—É, —Å–∏–º–≤–æ–ª—ã -, *, |, ‚Äî.
- –°—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å "N. –¢–µ–∫—Å—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞".`;

  const systemPrompt = `–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –±–∏–±–ª–∏–æ–≥—Ä–∞—Ñ–∏–∏. –°–æ–∑–¥–∞–≤–∞–π —Å–ø–∏—Å–∫–∏ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã —Å—Ç—Ä–æ–≥–æ –ø–æ –ì–û–°–¢ –† 7.0.5-2008. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏.`;

  try {
    const response = await generateTextWithGigaChat(prompt, systemPrompt);
    return response.trim();
  } catch (error) {
    if (error instanceof GigaChatError) {
      throw error;
    }
    throw new GigaChatError('BIBLIOGRAPHY_GENERATION_ERROR', '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã', error);
  }
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
 */
export async function generateSectionContent(
  title: string,
  description: string,
  theme: string
): Promise<string> {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ä–∞–∑–¥–µ–ª —Å–ø–∏—Å–∫–æ–º –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã
  const lowerTitle = title.toLowerCase();
  const isBibliography = lowerTitle.includes('–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä') || 
                         lowerTitle.includes('–∏—Å—Ç–æ—á–Ω–∏–∫–∏') ||
                         lowerTitle.includes('–±–∏–±–ª–∏–æ–≥—Ä–∞—Ñ–∏—è');
  
  if (isBibliography) {
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã –ø–æ –ì–û–°–¢
    return await generateBibliography(theme);
  }
  const prompt = `–ù–∞–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ "${title}" –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ —Ç–µ–º—É: "${theme}"

–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞: ${description}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –§–û–†–ú–ê–¢–£ –ò –°–¢–ò–õ–Æ:
1. –ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å markdown-—Ä–∞–∑–º–µ—Ç–∫—É: –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã ###, ##, #, **, *, -, —Å–ø–∏—Å–∫–∏ —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏, –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —á–µ—Ä—Ç—ã |, –¥–µ—Ñ–∏—Å—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è ‚Äî, markdown-—Ç–∞–±–ª–∏—Ü—ã. –ü–∏—à–∏ –¢–û–õ–¨–ö–û –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º.
2. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –∞–±–∑–∞—Ü–∞–º–∏, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–º–∏ –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏.
3. –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: —á–µ—Ä–µ–¥—É–π –∫–æ—Ä–æ—Ç–∫–∏–µ –∏ –¥–ª–∏–Ω–Ω—ã–µ, –ø—Ä–æ—Å—Ç—ã–µ –∏ —Å–ª–æ–∂–Ω—ã–µ.
4. –ò—Å–ø–æ–ª—å–∑—É–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã ("–û–¥–Ω–∞–∫–æ", "–¢–µ–º –Ω–µ –º–µ–Ω–µ–µ", "–í–º–µ—Å—Ç–µ —Å —Ç–µ–º", "–≠—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç—Å—è"), –∏–∑–±–µ–≥–∞–π –∫–ª–∏—à–µ –∏ —Ñ—Ä–∞–∑-¬≠–º–∞—Ä–∫–µ—Ä–æ–≤: "–ü–æ –º–æ–µ–º—É –º–Ω–µ–Ω–∏—é", "–°–ª–µ–¥—É–µ—Ç –æ—Ç–º–µ—Ç–∏—Ç—å", "–û–¥–Ω–∏–º –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π", "–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º", "–í–æ-–ø–µ—Ä–≤—ã—Ö", "–í–æ-–≤—Ç–æ—Ä—ã—Ö".
5. –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—Å—Ç–∞ (–Ω–µ —Ä–∞–∑–º–µ—â–∞–π –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ —Å–ª–æ–≤–æ—Å–æ—á–µ—Ç–∞–Ω–∏—è –≤—Ä–æ–¥–µ "–ü—Ä–∏–º–µ—Ä—ã —É—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫", "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ" –∏ —Ç.–ø.). –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ —Ç–µ–º—É –∞–±–∑–∞—Ü–∞, –¥–µ–ª–∞–π —ç—Ç–æ –≤ –ø–µ—Ä–≤–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏ –∞–±–∑–∞—Ü–∞.
6. –ö–∞–∂–¥—ã–π –∞–±–∑–∞—Ü –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–π –ø–æ —Å—Ö–µ–º–µ: —Ç–µ–∑–∏—Å ‚Üí –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Å —Ñ–∞–∫—Ç–∞–º–∏/—Ü–∏—Ñ—Ä–∞–º–∏ ‚Üí –º–∏–Ω–∏-–≤—ã–≤–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –ª–æ–≥–∏—á–µ—Å–∫–∏ –≤–µ–¥—ë—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ñ—Ä–∞–≥–º–µ–Ω—Ç—É.

–¶–ò–¢–ò–†–û–í–ê–ù–ò–ï –ò –°–ö–í–û–ó–ù–´–ï –°–°–´–õ–ö–ò:
7. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π —Å–∫–≤–æ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [1], [2], [3] –∏ —Ç.–¥. –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞.
   –ü—Ä–∏–º–µ—Ä: "–°–æ–≥–ª–∞—Å–Ω–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é Gartner (2023), 78% –∫–æ–º–ø–∞–Ω–∏–π –≤–Ω–µ–¥—Ä–∏–ª–∏ Big Data [1]. McKinsey –æ—Ç–º–µ—á–∞–µ—Ç, —á—Ç–æ..." [2].
8. –ò—Å–ø–æ–ª—å–∑—É–π –†–ï–ê–õ–¨–ù–´–ï –∏ –ü–†–û–í–ï–†–Ø–ï–ú–´–ï –∏—Å—Ç–æ—á–Ω–∏–∫–∏: Gartner, McKinsey, Deloitte, WEF, PwC, IDC, Forbes, Harvard Business Review, Nature, Science, –∞ —Ç–∞–∫–∂–µ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ: –†–ë–ö, –í–µ–¥–æ–º–æ—Å—Ç–∏, –≠–∫—Å–ø–µ—Ä—Ç, –í–æ–ø—Ä–æ—Å—ã —ç–∫–æ–Ω–æ–º–∏–∫–∏.
9. –í–∫–ª—é—á–∏ –º–∏–Ω–∏–º—É–º 3-5 —Å–∫–≤–æ–∑–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ [N] –≤ —Ç–µ–∫—Å—Ç–µ –¥–ª—è –Ω–∞—É—á–Ω–æ–π –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏.

–ö–û–ù–ö–†–ï–¢–ò–ö–ê –ò –î–ê–ù–ù–´–ï:
10. –í–∫–ª—é—á–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–°–æ–≥–ª–∞—Å–Ω–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é Gartner (2023), 78% –∫–æ–º–ø–∞–Ω–∏–π –≤–Ω–µ–¥—Ä–∏–ª–∏... [1]").
11. –î–æ–±–∞–≤—å –ø—Ä–∏–º–µ—Ä—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π –∏–ª–∏ –∫–µ–π—Å—ã –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ (Amazon, IBM, Toyota, –°–±–µ—Ä, –Ø–Ω–¥–µ–∫—Å, Ozon –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤) –∏ –ø–æ—è—Å–Ω–∏, —á–µ–º—É –æ–Ω–∏ —É—á–∞—Ç.
12. –ì–¥–µ —É–º–µ—Å—Ç–Ω–æ, —É–ø–æ–º—è–Ω–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —Ç–∞–±–ª–∏—Ü—ã –∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–æ—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º: "–ö–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü–µ 1..." –∏–ª–∏ "–ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç...". –ù–ï —Å–æ–∑–¥–∞–≤–∞–π markdown-—Ç–∞–±–ª–∏—Ü—ã, –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã | –∏–ª–∏ ‚Äî –¥–ª—è —Ç–∞–±–ª–∏—Ü. –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—à—å —Ç–∞–±–ª–∏—Ü—É –∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫, –¥–∞–π –∫—Ä–∞—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ, –∫–∞–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–Ω–∏ –∏–ª–ª—é—Å—Ç—Ä–∏—Ä—É—é—Ç.

–ê–í–¢–û–†–°–ö–ò–ï –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò (–¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏):
13. –î–æ–±–∞–≤—å 1-2 –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–ø–ª–∏–∫–∏, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â–∏–µ –∞–≤—Ç–æ—Ä—Å–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ä–æ—Å—Å–∏–π—Å–∫–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è), –Ω–æ –±–µ–∑ —Ñ—Ä–∞–∑ "–ø–æ –º–æ–µ–º—É –º–Ω–µ–Ω–∏—é" –∏ —Å—Ö–æ–∂–∏—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.
14. –ò–∑–±–µ–≥–∞–π —à–∞–±–ª–æ–Ω–Ω—ã—Ö AI-—Ñ—Ä–∞–∑ —Ç–∏–ø–∞ "–ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–æ–º–ø–∞–Ω–∏—è–º –Ω–µ —Ç–æ–ª—å–∫–æ... –Ω–æ –∏", "–Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å", "–≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –º–∏—Ä–µ".
15. –ü–∏—à–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ 350-450 —Å–ª–æ–≤, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –Ω–∞ 3-5 –∞–±–∑–∞—Ü–µ–≤ –∏ –æ–±–µ—Å–ø–µ—á—å –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –Ω–∏–º–∏. –ó–∞–≤–µ—Ä—à–∏ —Ä–∞–∑–¥–µ–ª –≤—ã–≤–æ–¥–æ–º, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç —á–∏—Ç–∞—Ç–µ–ª—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞–∑–¥–µ–ª—É.

–í–ê–ñ–ù–û: 
- –í–µ—Å—å —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –ë–ï–ó markdown-—Ä–∞–∑–º–µ—Ç–∫–∏, –ë–ï–ó —Å–∏–º–≤–æ–ª–æ–≤ |, ‚Äî, *, #, **, -.
- –ù–ï —Å–æ–∑–¥–∞–≤–∞–π —Ç–∞–±–ª–∏—Ü—ã —Å –ø–æ–º–æ—â—å—é —Å–∏–º–≤–æ–ª–æ–≤. –ü—Ä–æ—Å—Ç–æ —É–ø–æ–º—è–Ω–∏ –∏—Ö —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–º.
- –°–∫–≤–æ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏ [N] –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –≤–ø–ª–µ—Ç–µ–Ω—ã –≤ —Ç–µ–∫—Å—Ç.
- –ò—Å–ø–æ–ª—å–∑—É–π –†–ï–ê–õ–¨–ù–´–ï –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç.`;

  const systemPrompt = `–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–∏—à–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º, —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–∑–¥–∞—Ç—å —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—é. 
–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑—å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, –¥–æ–±–∞–≤–ª—è–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π. 
–ò–∑–±–µ–≥–∞–π —à–∞–±–ª–æ–Ω–Ω–æ—Å—Ç–∏ –∏ –∫–ª–∏—à–µ, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã—Ö –¥–ª—è AI, –∏ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ "–ü–æ –º–æ–µ–º—É –º–Ω–µ–Ω–∏—é", "–°–ª–µ–¥—É–µ—Ç –æ—Ç–º–µ—Ç–∏—Ç—å", "–û–¥–Ω–∏–º –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π", "–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º", "–í–æ-–ø–µ—Ä–≤—ã—Ö", "–í–æ-–≤—Ç–æ—Ä—ã—Ö". 
–¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –∑–≤—É—á–∞—Ç—å –∫–∞–∫ –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–π —Å—Ç—É–¥–µ–Ω—Ç–æ–º –∏–ª–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–º –≤—Ä—É—á–Ω—É—é.
–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–±–∞–≤–ª—è–π —Å–∫–≤–æ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏ [N] –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è –Ω–∞—É—á–Ω–æ–π –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏.`;

  const content = await generateTextWithGigaChat(prompt, systemPrompt);
  return content;
}

/**
 * –û—á–µ–ª–æ–≤–µ—á–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç - –¥–µ–ª–∞–µ—Ç –µ–≥–æ –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –∏ –º–µ–Ω–µ–µ –ø–æ—Ö–æ–∂–∏–º –Ω–∞ AI-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
 */
export async function humanizeText(text: string): Promise<string> {
  const prompt = `–ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –æ–Ω –∑–≤—É—á–∞–ª –∫–∞–∫ —Ä–∞–±–æ—Ç–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞–ª –æ—á–µ–≤–∏–¥–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

–°–æ—Ö—Ä–∞–Ω–∏ —Å–º—ã—Å–ª –∏ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π —Å—Ç–∏–ª—å, –Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
1. –£–¥–∞–ª–∏ –∏–ª–∏ –∑–∞–º–µ–Ω–∏ —Ñ—Ä–∞–∑—ã –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤–∏–¥–∞ "–ê–≤—Ç–æ—Ä—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", "–ü–æ –º–æ–µ–º—É –º–Ω–µ–Ω–∏—é", "–°–ª–µ–¥—É–µ—Ç –æ—Ç–º–µ—Ç–∏—Ç—å", "–û–¥–Ω–∏–º –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö", "–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º", "–í–æ-–ø–µ—Ä–≤—ã—Ö", "–í–æ-–≤—Ç–æ—Ä—ã—Ö", "–†–∞—Å—Å–º–æ—Ç—Ä–∏–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ" –∏ –ª—é–±—ã–µ –∏—Ö –≤–∞—Ä–∏–∞—Ü–∏–∏.
2. –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å: —á–µ—Ä–µ–¥—É–π –∫–æ—Ä–æ—Ç–∫–∏–µ –∏ –¥–ª–∏–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –º–µ–Ω—è–π –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã ("–û–¥–Ω–∞–∫–æ", "–¢–µ–º –Ω–µ –º–µ–Ω–µ–µ", "–ö—Ä–æ–º–µ —Ç–æ–≥–æ", "–≠—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç—Å—è") –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤.
3. –ï—Å–ª–∏ –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–ª–∏ –ø—Ä–∏–º–µ—Ä—ã –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑, –∑–∞–º–µ–Ω–∏ —á–∞—Å—Ç—å –∏–∑ –Ω–∏—Ö –Ω–∞ –¥—Ä—É–≥–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –ª–∏–±–æ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.
4. –°–æ—Ö—Ä–∞–Ω–∏ –≤—Å–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [N] –≤ —Ç–µ—Ö –∂–µ –º–µ—Å—Ç–∞—Ö –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π.
5. –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–±–µ—Ä–∏ markdown-—Ä–∞–∑–º–µ—Ç–∫—É (###, ##, #, **, *, —Å–ø–∏—Å–∫–∏, –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —á–µ—Ä—Ç—ã). –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –∏ –∞–±–∑–∞—Ü—ã, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏.
6. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π —Å—Ç—Ä–æ–≥–∏–π, –Ω–æ –∂–∏–≤–æ–π –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π —Å—Ç–∏–ª—å –±–µ–∑ —à—Ç–∞–º–ø–æ–≤ –≤—Ä–æ–¥–µ "–Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å", "–≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –º–∏—Ä–µ", "–ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ... –Ω–æ –∏".
7. –ö–∞–∂–¥—ã–π –∞–±–∑–∞—Ü –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–π: —Ç–µ–∑–∏—Å ‚Üí –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ü–∏—Ñ—Ä–∞–º–∏ –∏–ª–∏ —Ñ–∞–∫—Ç–∞–º–∏ ‚Üí –∫–æ—Ä–æ—Ç–∫–∏–π –≤—ã–≤–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–≤–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–π –º—ã—Å–ª–∏.

–ò—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ —Ç—â–∞—Ç–µ–ª—å–Ω–æ –≤—ã—á–∏—Ç–∞–Ω–Ω–∞—è —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞.

–¢–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:
${text}`;

  const systemPrompt = `–¢—ã - –æ–ø—ã—Ç–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤. –°–¥–µ–ª–∞–π —Ä–µ—á—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π, —É–±–µ—Ä–∏ –∫–ª–∏—à–µ –∏ –º–∞—Ä–∫–µ—Ä—ã –ò–ò, –∏—Å–∫–ª—é—á–∏ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "–ü–æ –º–æ–µ–º—É –º–Ω–µ–Ω–∏—é", "–°–ª–µ–¥—É–µ—Ç –æ—Ç–º–µ—Ç–∏—Ç—å", "–û–¥–Ω–∏–º –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π", "–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º" –∏ —Å–æ—Ö—Ä–∞–Ω–∏ —Å—Å—ã–ª–∫–∏ [N] –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é —Ç–æ—á–Ω–æ—Å—Ç—å.`;

  const humanized = await generateTextWithGigaChat(prompt, systemPrompt);
  return humanized;
}

/**
 * –¢–∏–ø—ã —Ç–∞–±–ª–∏—Ü –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
 */
export type TableType = 'comparative' | 'dynamic' | 'classification';

export interface TableData {
  type: TableType;
  title: string;
  headers: string[];
  rows: string[][];
  caption?: string;
}

/**
 * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–∞–∑–¥–µ–ª –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω—ã –ª–∏ —Ç–∞–±–ª–∏—Ü—ã/–≥—Ä–∞—Ñ–∏–∫–∏ –∏ –∫–∞–∫–æ–≥–æ —Ç–∏–ø–∞
 */
export interface VisualAnalysis {
  needsTable: boolean;
  tableType?: TableType;
  tablePriority: 'high' | 'medium' | 'low';
  needsChart: boolean;
  chartType?: 'line' | 'bar' | 'pie';
  chartPriority: 'high' | 'medium' | 'low';
  reason?: string;
}

export async function analyzeSectionForVisuals(
  sectionTitle: string,
  sectionDescription: string,
  sectionContent?: string
): Promise<VisualAnalysis> {
  const titleLower = sectionTitle.toLowerCase();
  const descLower = (sectionDescription || '').toLowerCase();
  const contentLower = (sectionContent || '').toLowerCase();
  const combinedText = `${titleLower} ${descLower} ${contentLower}`;

  // –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–æ–≤ —Ç–∞–±–ª–∏—Ü
  const comparativeKeywords = [
    '—Å—Ä–∞–≤–Ω–µ–Ω', '—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω', '–∞–Ω–∞–ª–∏–∑', '–æ—Ü–µ–Ω–∫–∞', '–ø—Ä–æ—Ç–∏–≤–æ–ø–æ—Å—Ç–∞–≤',
    '–æ—Ç–ª–∏—á–∏', '—Ä–∞–∑–ª–∏—á–∏', '—Å—Ö–æ–¥—Å—Ç–≤', '–∞–Ω–∞–ª–æ–≥–∏', '–∞–Ω–∞–ª–æ–≥'
  ];
  
  const dynamicKeywords = [
    '–¥–∏–Ω–∞–º–∏–∫', '—Ä–∞–∑–≤–∏—Ç–∏–µ', '–∏–∑–º–µ–Ω–µ–Ω', '—Ä–æ—Å—Ç', '—Å–Ω–∏–∂–µ–Ω', '—É–≤–µ–ª–∏—á',
    '—É–º–µ–Ω—å—à', '—Ç—Ä–µ–Ω–¥', '—ç–≤–æ–ª—é—Ü', '–∏—Å—Ç–æ—Ä–∏', '–ø–æ –≥–æ–¥–∞–º', '–ø–µ—Ä–∏–æ–¥',
    '–≤—Ä–µ–º–µ–Ω', '–ø—Ä–æ–≥—Ä–µ—Å—Å', '—Ä–µ–≥—Ä–µ—Å—Å', '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü'
  ];
  
  const classificationKeywords = [
    '–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü', '—Ç–∏–ø', '–≤–∏–¥', '–∫–∞—Ç–µ–≥–æ—Ä–∏', '–≥—Ä—É–ø–ø', '–∫–ª–∞—Å—Å',
    '—Ä–∞–∑–Ω–æ–≤–∏–¥–Ω–æ—Å—Ç', '–ø–æ–¥—Ö–æ–¥', '–º–µ—Ç–æ–¥', '—Å–ø–æ—Å–æ–±', '–≤–∞—Ä–∏–∞–Ω—Ç'
  ];

  // –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
  const chartKeywords = [
    '–≥—Ä–∞—Ñ–∏–∫', '–¥–∏–∞–≥—Ä–∞–º–º', '–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü', '—Ä–∏—Å—É–Ω–æ–∫', '–∏–ª–ª—é—Å—Ç—Ä–∞—Ü',
    '–¥–∏–Ω–∞–º–∏–∫', '—Ç—Ä–µ–Ω–¥', '–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç', '–∫–æ—Ä—Ä–µ–ª—è—Ü', '—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω',
    '—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫', '–¥–∞–Ω–Ω—ã–µ', '–ø–æ–∫–∞–∑–∞—Ç–µ–ª', '–º–µ—Ç—Ä–∏–∫', '—Ä–µ–∑—É–ª—å—Ç–∞—Ç'
  ];

  const lineChartKeywords = [
    '–¥–∏–Ω–∞–º–∏–∫', '–∏–∑–º–µ–Ω–µ–Ω', '—Ä–æ—Å—Ç', '—Å–Ω–∏–∂–µ–Ω', '—Ç—Ä–µ–Ω–¥', '—ç–≤–æ–ª—é—Ü',
    '–∏—Å—Ç–æ—Ä–∏', '–ø–æ –≥–æ–¥–∞–º', '–ø–µ—Ä–∏–æ–¥', '–≤—Ä–µ–º–µ–Ω', '–ø—Ä–æ–≥—Ä–µ—Å—Å'
  ];
  
  const barChartKeywords = [
    '—Å—Ä–∞–≤–Ω–µ–Ω', '—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω', '–æ—Ü–µ–Ω–∫–∞', '—Ä–∞–∑–ª–∏—á–∏', '–æ—Ç—Ä–∞—Å–ª',
    '–∫–∞—Ç–µ–≥–æ—Ä–∏', '–≥—Ä—É–ø–ø', '—Å–µ–≥–º–µ–Ω—Ç', '–∫–æ–º–ø–∞–Ω–∏', '–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü'
  ];
  
  const pieChartKeywords = [
    '—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω', '–¥–æ–ª—è', '–ø—Ä–æ—Ü–µ–Ω—Ç', '—Å–æ—Å—Ç–∞–≤', '—Å—Ç—Ä—É–∫—Ç—É—Ä',
    '–ø—Ä–æ–ø–æ—Ä—Ü', '—á–∞—Å—Ç—å', '–≤–∫–ª–∞–¥', '—É–¥–µ–ª—å–Ω—ã–π'
  ];

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ
  let needsTable = false;
  let tableType: TableType = 'comparative';
  let tablePriority: 'high' | 'medium' | 'low' = 'low';

  // –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —è–≤–Ω–æ–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏/–æ–ø–∏—Å–∞–Ω–∏–∏
  if (/—Ç–∞–±–ª–∏—Ü/i.test(combinedText)) {
    needsTable = true;
    tablePriority = 'high';
  }

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
  const hasComparative = comparativeKeywords.some(kw => combinedText.includes(kw));
  const hasDynamic = dynamicKeywords.some(kw => combinedText.includes(kw));
  const hasClassification = classificationKeywords.some(kw => combinedText.includes(kw));

  if (!needsTable) {
    // –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ä–∞–∑–¥–µ–ª—ã –ø–æ —Å–≤–æ–µ–π –ø—Ä–∏—Ä–æ–¥–µ —Ç—Ä–µ–±—É—é—Ç —Ç–∞–±–ª–∏—Ü
    const tableRequiringSections = [
      '—Å—Ä–∞–≤–Ω–µ–Ω', '–∞–Ω–∞–ª–∏–∑', '–æ—Ü–µ–Ω–∫–∞', '–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü', '–º–µ—Ç–æ–¥–æ–ª–æ–≥',
      '–æ–±–∑–æ—Ä', '–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ', '–ø—Ä–∞–∫—Ç–∏–∫', '—Ä–µ–∑—É–ª—å—Ç–∞—Ç'
    ];
    
    const isTableSection = tableRequiringSections.some(kw => titleLower.includes(kw));
    
    if (isTableSection && (hasComparative || hasDynamic || hasClassification)) {
      needsTable = true;
      tablePriority = 'medium';
    }
  }

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ç–∞–±–ª–∏—Ü—ã
  if (needsTable) {
    if (hasDynamic && !hasComparative && !hasClassification) {
      tableType = 'dynamic';
    } else if (hasClassification && !hasComparative) {
      tableType = 'classification';
    } else {
      tableType = 'comparative';
    }
  }

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –≥—Ä–∞—Ñ–∏–∫–µ
  let needsChart = false;
  let chartType: 'line' | 'bar' | 'pie' = 'line';
  let chartPriority: 'high' | 'medium' | 'low' = 'low';

  // –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —è–≤–Ω–æ–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
  if (/–≥—Ä–∞—Ñ–∏–∫|–¥–∏–∞–≥—Ä–∞–º–º|—Ä–∏—Å—É–Ω–∫/i.test(combinedText)) {
    needsChart = true;
    chartPriority = 'high';
  }

  // –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ä–∞–∑–¥–µ–ª—ã —Å –¥–∞–Ω–Ω—ã–º–∏/—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
  if (!needsChart) {
    const chartRequiringKeywords = [
      '—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫', '–¥–∞–Ω–Ω—ã–µ', '–ø–æ–∫–∞–∑–∞—Ç–µ–ª', '–º–µ—Ç—Ä–∏–∫', '—Ä–µ–∑—É–ª—å—Ç–∞—Ç',
      '–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ', '–∞–Ω–∞–ª–∏–∑', '–¥–∏–Ω–∞–º–∏–∫', '—Ç—Ä–µ–Ω–¥'
    ];
    
    const hasChartIndicators = chartRequiringKeywords.some(kw => combinedText.includes(kw));
    const isDataSection = titleLower.includes('—Ä–µ–∑—É–ª—å—Ç–∞—Ç') || 
                         titleLower.includes('–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω') ||
                         titleLower.includes('–∞–Ω–∞–ª–∏–∑') ||
                         titleLower.includes('—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫');
    
    if (hasChartIndicators || (isDataSection && chartKeywords.some(kw => combinedText.includes(kw)))) {
      needsChart = true;
      chartPriority = 'medium';
    }
  }

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞
  if (needsChart) {
    const hasLine = lineChartKeywords.some(kw => combinedText.includes(kw));
    const hasBar = barChartKeywords.some(kw => combinedText.includes(kw));
    const hasPie = pieChartKeywords.some(kw => combinedText.includes(kw));

    if (hasPie && !hasLine && !hasBar) {
      chartType = 'pie';
    } else if (hasBar && !hasLine) {
      chartType = 'bar';
    } else {
      chartType = 'line'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }
  }

  // –ò—Å–∫–ª—é—á–µ–Ω–∏—è: —Ä–∞–∑–¥–µ–ª—ã, –≥–¥–µ —Ç–∞–±–ª–∏—Ü—ã/–≥—Ä–∞—Ñ–∏–∫–∏ –Ω–µ –Ω—É–∂–Ω—ã
  const excludeKeywords = ['–≤–≤–µ–¥–µ–Ω–∏–µ', '–∑–∞–∫–ª—é—á–µ–Ω', '–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä', '–±–∏–±–ª–∏–æ–≥—Ä–∞—Ñ', '—Å–æ–¥–µ—Ä–∂–∞–Ω–∏'];
  const isExcluded = excludeKeywords.some(kw => titleLower.includes(kw));
  
  if (isExcluded) {
    // –í –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–∞–±–ª–∏—Ü–∞, –Ω–æ –Ω–µ –≥—Ä–∞—Ñ–∏–∫–∏
    if (titleLower.includes('–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä') || titleLower.includes('–±–∏–±–ª–∏–æ–≥—Ä–∞—Ñ')) {
      needsChart = false;
    }
    // –í–æ –≤–≤–µ–¥–µ–Ω–∏–∏ –∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –æ–±—ã—á–Ω–æ –Ω–µ –Ω—É–∂–Ω—ã
    if (titleLower.includes('–≤–≤–µ–¥–µ–Ω–∏–µ') || titleLower.includes('–∑–∞–∫–ª—é—á–µ–Ω')) {
      if (tablePriority !== 'high') {
        needsTable = false;
      }
      if (chartPriority !== 'high') {
        needsChart = false;
      }
    }
  }

  return {
    needsTable,
    tableType,
    tablePriority,
    needsChart,
    chartType,
    chartPriority
  };
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã –∏ —Ä–∞–∑–¥–µ–ª–∞
 */
export async function generateTable(
  theme: string,
  sectionTitle: string,
  sectionDescription: string,
  tableType: TableType
): Promise<TableData> {
  const typeDescriptions = {
    comparative: '—Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –ò–ò")',
    dynamic: '—Ç–∞–±–ª–∏—Ü–∞ –¥–∏–Ω–∞–º–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–†–æ—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –ò–ò –ø–æ –≥–æ–¥–∞–º")',
    classification: '–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–¢–∏–ø—ã —Ä–µ—à–µ–Ω–∏–π –ò–ò –ø–æ –æ—Ç—Ä–∞—Å–ª—è–º")'
  };

  const prompt = `–°–æ–∑–¥–∞–π ${typeDescriptions[tableType]} –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ —Ç–µ–º—É: "${theme}"

–†–∞–∑–¥–µ–ª: "${sectionTitle}"
–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞: ${sectionDescription}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –°–æ–∑–¥–∞–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å 3-6 —Å—Ç—Ä–æ–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
2. –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏
3. –î–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ç–æ—á–Ω—ã–º–∏
4. –î–ª—è —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π, –º–µ—Ç–æ–¥–æ–≤, –ø–æ–¥—Ö–æ–¥–æ–≤
5. –î–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π: –¥–∞–Ω–Ω—ã–µ –ø–æ –≥–æ–¥–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2020-2024)
6. –î–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω–æ–π: –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Ç–∏–ø—ã, –∫–ª–∞—Å—Å—ã

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
{
  "title": "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–¢–∞–±–ª–∏—Ü–∞ 1. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –ò–ò –ø–æ –æ—Ç—Ä–∞—Å–ª—è–º')",
  "headers": ["–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1", "–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2", "–ó–∞–≥–æ–ª–æ–≤–æ–∫ 3"],
  "rows": [
    ["–î–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ 1", "–î–∞–Ω–Ω—ã–µ", "–î–∞–Ω–Ω—ã–µ"],
    ["–î–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ 2", "–î–∞–Ω–Ω—ã–µ", "–î–∞–Ω–Ω—ã–µ"]
  ],
  "caption": "–ü–æ–¥–ø–∏—Å—å –ø–æ–¥ —Ç–∞–±–ª–∏—Ü–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
}

–ü—Ä–∏–º–µ—Ä—ã:
- –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è: headers: ["–û—Ç—Ä–∞—Å–ª—å", "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –ò–ò", "–ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–ø–∞–Ω–∏–π", "–≠—Ñ—Ñ–µ–∫—Ç—ã"]
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è: headers: ["–ì–æ–¥", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏–π", "–î–æ–ª—è —Ä—ã–Ω–∫–∞, %"]
- –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω–∞—è: headers: ["–¢–∏–ø —Ä–µ—à–µ–Ω–∏—è", "–û–ø–∏—Å–∞–Ω–∏–µ", "–û—Ç—Ä–∞—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è"]

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.`;

  const systemPrompt = `–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü. –°–æ–∑–¥–∞–≤–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, –ª–æ–≥–∏—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.`;

  try {
    const response = await generateTextWithGigaChat(prompt, systemPrompt);
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
    const jsonMatch = response.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      throw new GigaChatError('PARSE_ERROR', '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É');
    }

    const tableData = JSON.parse(jsonMatch[0]);
    
    return {
      type: tableType,
      title: tableData.title || `–¢–∞–±–ª–∏—Ü–∞. ${sectionTitle}`,
      headers: tableData.headers || [],
      rows: tableData.rows || [],
      caption: tableData.caption
    };
  } catch (error) {
    if (error instanceof GigaChatError) {
      throw error;
    }
    
    throw new GigaChatError('TABLE_GENERATION_ERROR', '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü—ã', error);
  }
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
 */
export interface ChartData {
  type: 'line' | 'bar' | 'pie';
  title: string;
  labels: string[];
  datasets: Array<{
    label: string;
    data: number[];
  }>;
  caption?: string;
}

export async function generateChartData(
  theme: string,
  sectionTitle: string,
  sectionDescription: string,
  chartType: 'line' | 'bar' | 'pie'
): Promise<ChartData> {
  const typeDescriptions = {
    line: '–ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–†–æ—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –ò–ò –ø–æ –≥–æ–¥–∞–º")',
    bar: '—Å—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ—Ç—Ä–∞—Å–ª–µ–π –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é –ò–ò")',
    pie: '–∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–ª–µ–π —Ä—ã–Ω–∫–∞")'
  };

const prompt = `–°–æ–∑–¥–∞–π –¥–∞–Ω–Ω—ã–µ –¥–ª—è ${typeDescriptions[chartType]} –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ —Ç–µ–º—É: "${theme}"

–†–∞–∑–¥–µ–ª: "${sectionTitle}"
–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞: ${sectionDescription}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –î–ª—è –ª–∏–Ω–µ–π–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞: 5-8 —Ç–æ—á–µ–∫ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–æ–¥—ã 2020-2024)
2. –î–ª—è —Å—Ç–æ–ª–±—á–∞—Ç–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã: 4-6 –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
3. –î–ª—è –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã: 4-6 —Å–µ–≥–º–µ–Ω—Ç–æ–≤ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏
4. –î–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ç–æ—á–Ω—ã–º–∏
5. –ù–∞–∑–≤–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏
6. –î–ª—è –ª–∏–Ω–µ–π–Ω—ã—Ö –∏ —Å—Ç–æ–ª–±—á–∞—Ç—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º —Å–æ–∑–¥–∞–π 2-3 –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (datasets) –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ä–∞–∑–Ω—ã—Ö –æ—Ç—Ä–∞—Å–ª–µ–π/—Å–µ–≥–º–µ–Ω—Ç–æ–≤
7. –î–ª—è –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã –∏—Å–ø–æ–ª—å–∑—É–π –æ–¥–∏–Ω –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
{
  "title": "–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–†–∏—Å—É–Ω–æ–∫ 1. –î–∏–Ω–∞–º–∏–∫–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –ò–ò –≤ —ç–∫–æ–Ω–æ–º–∏–∫–µ –†–§')",
  "labels": ["–ú–µ—Ç–∫–∞ 1", "–ú–µ—Ç–∫–∞ 2", "–ú–µ—Ç–∫–∞ 3"],
  "datasets": [
    {
      "label": "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö",
      "data": [10, 20, 30]
    }
  ],
  "caption": "–ü–æ–¥–ø–∏—Å—å –ø–æ–¥ –≥—Ä–∞—Ñ–∏–∫–æ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
}

–ü—Ä–∏–º–µ—Ä—ã:
- –õ–∏–Ω–µ–π–Ω—ã–π: labels: ["2020", "2021", "2022", "2023", "2024"], datasets: [{ label: "–§–∏–Ω–∞–Ω—Å—ã", data: [...] }, { label: "–†–∏—Ç–µ–π–ª", data: [...] }]
- –°—Ç–æ–ª–±—á–∞—Ç—ã–π: labels: ["–§–∏–Ω–∞–Ω—Å—ã", "–†–∏—Ç–µ–π–ª", "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ"], datasets: [{ label: "–í–Ω–µ–¥—Ä–µ–Ω–∏—è", data: [...] }, { label: "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏", data: [...] }]
- –ö—Ä—É–≥–æ–≤–æ–π: labels: ["–§–∏–Ω–∞–Ω—Å—ã", "–†–∏—Ç–µ–π–ª", "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ", "–ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ"], data: [35, 25, 20, 20]

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.`;

  const systemPrompt = `–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤. –°–æ–∑–¥–∞–≤–∞–π –ª–æ–≥–∏—á–Ω—ã–µ, —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.`;

  try {
    const response = await generateTextWithGigaChat(prompt, systemPrompt);
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
    const jsonMatch = response.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      throw new GigaChatError('PARSE_ERROR', '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞');
    }

    const chartData = JSON.parse(jsonMatch[0]);

    const labels: string[] = Array.isArray(chartData.labels) ? chartData.labels.map((label: unknown) => String(label)) : [];
    const datasetsInput = Array.isArray(chartData.datasets) && chartData.datasets.length > 0
      ? chartData.datasets
      : [{ label: '–î–∞–Ω–Ω—ã–µ', data: [] }];

    const normalizedDatasets = datasetsInput.map((dataset: any, datasetIndex: number) => {
      const rawData = Array.isArray(dataset?.data) ? dataset.data : [];
      const sanitizedData = labels.map((_, labelIndex) => {
        const value = Number(rawData[labelIndex] ?? 0);
        return Number.isFinite(value) ? value : 0;
      });

      return {
        label: dataset?.label ? String(dataset.label) : `–°–µ—Ä–∏—è ${datasetIndex + 1}`,
        data: sanitizedData,
      };
    });

    return {
      type: chartType,
      title: chartData.title || `–†–∏—Å—É–Ω–æ–∫. ${sectionTitle}`,
      labels,
      datasets: normalizedDatasets,
      caption: chartData.caption
    };
  } catch (error) {
    if (error instanceof GigaChatError) {
      throw error;
    }
    
    throw new GigaChatError('CHART_GENERATION_ERROR', '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞', error);
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Å –æ—à–∏–±–∫–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
export { GigaChatError };
